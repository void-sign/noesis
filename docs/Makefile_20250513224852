# Noesis Project Makefile

# Compiler and flags
CC = gcc
CFLAGS = -Wall -Wextra -std=c99
INCLUDES = -Iinclude -I. -I. -Ilibs/noesis_libc/include
LIBPATH = -Lbuild/lib
LIBS = -lnlibc_stubs

# Directories
SRC_DIR = src
OBJ_DIR = build/obj
BIN_DIR = build/bin
ASM_DIR = src/utils/asm

# Source files
CORE_SRC = $(wildcard $(SRC_DIR)/core/*.c)
UTILS_SRC = $(filter-out $(SRC_DIR)/utils/write.c, $(wildcard $(SRC_DIR)/utils/*.c))
API_SRC = $(SRC_DIR)/api/noesis_api.c
QUANTUM_SRC = $(wildcard $(SRC_DIR)/quantum/*.c) $(wildcard $(SRC_DIR)/quantum/field/*.c)
ASM_SRC = $(filter-out $(ASM_DIR)/write.s, $(wildcard $(ASM_DIR)/*.s))

# Object files
CORE_OBJ = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(CORE_SRC))
UTILS_OBJ = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(UTILS_SRC))
API_OBJ = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(API_SRC))
QUANTUM_OBJ = $(patsubst $(SRC_DIR)/%.c,$(OBJ_DIR)/%.o,$(QUANTUM_SRC))
ASM_OBJ = $(patsubst $(ASM_DIR)/%.s,$(OBJ_DIR)/asm/%.o,$(ASM_SRC))

# All object files
OBJECTS = $(CORE_OBJ) $(UTILS_OBJ) $(API_OBJ) $(QUANTUM_OBJ) $(ASM_OBJ)

# Output binary
TARGET = noesis
TEST_TARGET = noesis_tests
QBUILD = $(BIN_DIR)/qbuild
QRUN = $(BIN_DIR)/qrun

# Default target
all: directories $(TARGET) $(TEST_TARGET) $(QBUILD) $(QRUN)

# Create necessary directories
directories:
	mkdir -p $(OBJ_DIR)/core
	mkdir -p $(OBJ_DIR)/utils
	mkdir -p $(OBJ_DIR)/api
	mkdir -p $(OBJ_DIR)/quantum
	mkdir -p $(OBJ_DIR)/quantum/field
	mkdir -p $(OBJ_DIR)/asm
	mkdir -p $(BIN_DIR)

# Compile C files
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	$(CC) $(CFLAGS) $(INCLUDES) -c $< -o $@

# Special rule for API files
$(OBJ_DIR)/api/%.o: $(SRC_DIR)/api/%.c
	$(CC) $(CFLAGS) $(INCLUDES) -DNOESIS_BUILDING_LIB -c $< -o $@

# Assemble ASM files
$(OBJ_DIR)/asm/%.o: $(ASM_DIR)/%.s
	as -o $@ $<

# Link the main program
$(TARGET): $(OBJECTS)
	$(CC) $(OBJECTS) $(LIBPATH) $(LIBS) -o $@

# Build tests
$(TEST_TARGET): $(OBJECTS)
	$(CC) $(OBJECTS) $(LIBPATH) $(LIBS) -DNOESIS_TESTING -o $@

# Build qbuild and qrun tools
$(QBUILD):
	$(CC) $(CFLAGS) $(INCLUDES) $(SRC_DIR)/tools/qbuild.c $(LIBPATH) $(LIBS) -o $@

$(QRUN):
	$(CC) $(CFLAGS) $(INCLUDES) $(SRC_DIR)/tools/qrun.c $(LIBPATH) $(LIBS) -o $@

# Tests
test: $(TEST_TARGET)
	./$(TEST_TARGET)

# Clean up
clean:
	rm -rf $(OBJ_DIR)
	rm -f $(TARGET) $(TEST_TARGET) $(QBUILD) $(QRUN)

.PHONY: all clean directories test
